<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use MarcReichel\IGDBLaravel\Models\Game;
use MarcReichel\IGDBLaravel\Models\Cover;
use MarcReichel\IGDBLaravel\Models\InvolvedCompany;
use MarcReichel\IGDBLaravel\Models\Company;
use MarcReichel\IGDBLaravel\Models\Genre;
use App\Models\ResultadoBuscaJogo;

class IgdbController extends Controller {

    private $plataformas = [
        '6', // PC (Microsoft Windows)
        '7', // PlayStation
        '8', // PlayStation 2
        '9', // PlayStation 3
        '38', // PlayStation Portable
        '46', // PlayStation Vita
        '48', // PlayStation 4
        '167', // PlayStation 5
    ];
    
    public function buscarJogos(Request $request) {
        $resultado = [];

        $games = Game::search($request['titulo'])
                        ->select(['name', 'cover', 'platforms'])
                        ->whereIn('platforms', $this->plataformas)
                        ->where('category', '!=', 1)
                            ->take(50)
                                ->get();

        foreach ($games as $game) {
            $cover = null;
            if ($game->cover != null) {
                $cover = Cover::find($game->cover);
            }
            $resultado[] = new ResultadoBuscaJogo($game->id, $game->name, $this->buscarUrlImagem('cover_small', @$cover->image_id));
        }

        return $resultado;
    }

    public function buscarDadosJogo($id) {
        $game = Game::find($id);

        $cover = null;
        if ($game->cover != null) {
            $cover = Cover::find($game->cover);
        }

        $developers = Company::whereIn('id', InvolvedCompany::whereIn('id', $game->involved_companies)->where('developer', true)->get()->pluck('company')->toArray())->get()->pluck('name');
        $publishers = Company::whereIn('id', InvolvedCompany::whereIn('id', $game->involved_companies)->where('publisher', true)->get()->pluck('company')->toArray())->get()->pluck('name');
        $genres = Genre::whereIn('id', $game->genres)->get()->pluck('name');

        return [
            'id' => $game->id,
            'titulo' => $game->name,
            'descricao' => $game->summary,
            'id_imagem' => @$cover->image_id,
            'lista_developer' => $developers,
            'lista_publisher' => $publishers,
            'genres' => $genres
        ];
    }

    public function buscarUrlImagem($tamanho, $hash) {
        // cover_small	    90 x 128	Fit
        // screenshot_med	569 x 320	Lfill, Center gravity
        // cover_big	    264 x 374	Fit
        // logo_med	        284 x 160	Fit
        // screenshot_big	889 x 500	Lfill, Center gravity
        // screenshot_huge	1280 x 720	Lfill, Center gravity
        // thumb	        90 x 90	    Thumb, Center gravity
        // micro	        35 x 35	    Thumb, Center gravity
        // 720p	            1280 x 720	Fit, Center gravity
        // 1080p	        1920 x 1080	Fit, Center gravity
        if ($hash == '') {
            return null;
        }
        return "https://images.igdb.com/igdb/image/upload/t_".$tamanho."/".$hash.".jpg";
    }

}

// {
//     "age_ratings": [
//         3456
//     ],
//     "aggregated_rating": 84.6,
//     "aggregated_rating_count": 2,
//     "alternative_names": [
//         18271,
//         18272
//     ],
//     "category": 0,
//     "collection": 183,
//     "cover": 77321,
//     "created_at": "2011-10-04T00:00:00.000000Z",
//     "external_games": [
//         12853,
//         154259,
//         225226,
//         245144,
//         250081
//     ],
//     "first_release_date": "1996-10-01T00:00:00.000000Z",
//     "game_modes": [
//         1
//     ],
//     "genres": [
//         5,
//         8,
//         9,
//         31
//     ],
//     "id": 912,
//     "involved_companies": [
//         1973,
//         21227,
//         42061,
//         42062
//     ],
//     "keywords": [
//         21,
//         46,
//         64,
//         72,
//         87,
//         121,
//         129,
//         132,
//         221,
//         339,
//         365,
//         390,
//         394,
//         420,
//         558,
//         594,
//         598,
//         623,
//         658,
//         698,
//         770,
//         864,
//         872,
//         902,
//         926,
//         962,
//         966,
//         1019,
//         1025,
//         1033,
//         1098,
//         1138,
//         1158,
//         1190,
//         1202,
//         1228,
//         1240,
//         1272,
//         1289,
//         1293,
//         1320,
//         1345,
//         1421,
//         1454,
//         1494,
//         1507,
//         1710,
//         1714,
//         1716,
//         1737,
//         1756,
//         1834,
//         1846,
//         1971,
//         2049,
//         2112,
//         2141,
//         2154,
//         2280,
//         2324,
//         2337,
//         2414,
//         2415,
//         2438,
//         2450,
//         2452,
//         2513,
//         2543,
//         2561,
//         2678,
//         2679,
//         2841,
//         2875,
//         3061,
//         3203,
//         3228,
//         3297,
//         3486,
//         3640,
//         3794,
//         3831,
//         3901,
//         3910,
//         3994,
//         4004,
//         4035,
//         4130,
//         4134,
//         4135,
//         4138,
//         4140,
//         4145,
//         4161,
//         4166,
//         4171,
//         4173,
//         4177,
//         4183,
//         4185,
//         4187,
//         4195,
//         4202,
//         4215,
//         4218,
//         4245,
//         4246,
//         4280,
//         4282,
//         4284,
//         4287,
//         4292,
//         4293,
//         4296,
//         4304,
//         4316,
//         4317,
//         4320,
//         4330,
//         4337,
//         4338,
//         4345,
//         4353,
//         4359,
//         4363,
//         4364,
//         4369,
//         4372,
//         4374,
//         4389,
//         4390,
//         4392,
//         4393,
//         4394,
//         4396,
//         4397,
//         4400,
//         4403,
//         4407,
//         4412,
//         4419,
//         4428,
//         4430,
//         4432,
//         4446,
//         4450,
//         4460,
//         4484,
//         4488,
//         4508,
//         4509,
//         4514,
//         4520,
//         4525,
//         4526,
//         4541,
//         4542,
//         4543,
//         4544,
//         4548,
//         4552,
//         4571,
//         4573,
//         4574,
//         4576,
//         4578,
//         4579,
//         4580,
//         4581,
//         4582,
//         4590,
//         4592,
//         4594,
//         4595,
//         4596,
//         4611,
//         4613,
//         4614,
//         4615,
//         4616,
//         4619,
//         4620,
//         4624,
//         4625,
//         4628,
//         4630,
//         4632,
//         4633,
//         4634,
//         4635,
//         4637,
//         4638,
//         4642,
//         4659,
//         4660,
//         4662,
//         4668,
//         4671,
//         4681,
//         4685,
//         4694,
//         4697,
//         4709,
//         4711,
//         4712,
//         4713,
//         4726,
//         4727,
//         4731,
//         4738,
//         4745,
//         4755,
//         4756,
//         4762,
//         4763,
//         4779,
//         4781,
//         4783,
//         4787,
//         4788,
//         4793,
//         4817,
//         4829,
//         4830,
//         4831,
//         4833,
//         4845,
//         4848,
//         4865,
//         4869,
//         4880,
//         4885,
//         4891,
//         4892,
//         4896,
//         4897,
//         4899,
//         4901,
//         4907,
//         4910,
//         4918,
//         4920,
//         4928,
//         4958,
//         4977,
//         4979,
//         4991,
//         4998,
//         4999,
//         5000,
//         5007,
//         5008,
//         5025,
//         5029,
//         5039,
//         5096,
//         5099,
//         5102,
//         5103,
//         5109,
//         5111,
//         5117,
//         5119,
//         5164,
//         5171,
//         5172,
//         5176,
//         5185,
//         5196,
//         5217,
//         5256,
//         5257,
//         5259,
//         5260,
//         5266,
//         5269,
//         5271,
//         5273,
//         5274,
//         5293,
//         5295,
//         5298,
//         5308,
//         5309,
//         5323,
//         5329,
//         5345,
//         5349,
//         5350,
//         5359,
//         5362,
//         5363,
//         5365,
//         5375,
//         5386,
//         5391,
//         5406,
//         5407,
//         5409,
//         5410,
//         5413,
//         5419,
//         5421,
//         5427,
//         5439,
//         5444,
//         5446,
//         5452,
//         5453,
//         5462,
//         5465,
//         5467,
//         5501,
//         5502,
//         5504,
//         5507,
//         5511,
//         5515,
//         5518,
//         5534,
//         5535,
//         5549,
//         5552,
//         5554,
//         5561,
//         5564,
//         5581,
//         5586,
//         5590,
//         5592,
//         5599,
//         5609,
//         5616,
//         5621,
//         5622,
//         5628,
//         5641,
//         5644,
//         5645,
//         5650,
//         5652,
//         5658,
//         5665,
//         5680,
//         5687,
//         5705,
//         5712,
//         5713,
//         5717,
//         5730,
//         5742,
//         5753,
//         5756,
//         5757,
//         5762,
//         5771,
//         5775,
//         5783,
//         5789,
//         5799,
//         5810,
//         5823,
//         5839,
//         5843,
//         5845,
//         5855,
//         5858,
//         5885,
//         5904,
//         5905,
//         5914,
//         5920,
//         5935,
//         5939,
//         5940,
//         5941,
//         5950,
//         5956,
//         5965,
//         5967,
//         5968,
//         5986,
//         5989,
//         5999,
//         6007,
//         6017,
//         6026,
//         6052,
//         6062,
//         6119,
//         6128,
//         6131,
//         6135,
//         6144,
//         6165,
//         6215,
//         6216,
//         6239,
//         6245,
//         6248,
//         6257,
//         6258,
//         6261,
//         6295,
//         6298,
//         6325,
//         6341,
//         6374,
//         6375,
//         6376,
//         6377,
//         6378,
//         6382,
//         6397,
//         6410,
//         6426,
//         6440,
//         6442,
//         6443,
//         6457,
//         6472,
//         6477,
//         6481,
//         6493,
//         6512,
//         6513,
//         6589,
//         6624,
//         6625,
//         6655,
//         6716,
//         6736,
//         6737,
//         6738,
//         6749,
//         6752,
//         6813,
//         6841,
//         6850,
//         6863,
//         6868,
//         6895,
//         6897,
//         6903,
//         6916,
//         6994,
//         6995,
//         7000,
//         7038,
//         7043,
//         7044,
//         7046,
//         7052,
//         7053,
//         7064,
//         7073,
//         7074,
//         7080,
//         7092,
//         7125,
//         7152,
//         7153,
//         7215,
//         7220,
//         7235,
//         7288,
//         7303,
//         7305,
//         7334,
//         7403,
//         7405,
//         7408,
//         7465,
//         7494,
//         7497,
//         7498,
//         7503,
//         7515,
//         7552,
//         7569,
//         7576,
//         7578,
//         7643,
//         7655,
//         7660,
//         7664,
//         7672,
//         7679,
//         8100,
//         8130,
//         8138,
//         8160,
//         8177,
//         8265,
//         8299,
//         8802,
//         8806,
//         8819,
//         8847,
//         8854,
//         8906,
//         8958,
//         9130,
//         9258,
//         9283,
//         9296,
//         9364,
//         9380,
//         9462,
//         9529,
//         9655,
//         9849,
//         9951,
//         9971,
//         9972,
//         10036,
//         10085,
//         10133,
//         10149,
//         10418,
//         10486,
//         10544,
//         10730,
//         10751,
//         10814,
//         11099,
//         11287,
//         11311,
//         11351,
//         11853,
//         12170,
//         12180,
//         12260,
//         12710,
//         12743,
//         12848,
//         13126,
//         13127,
//         13951
//     ],
//     "name": "Tomb Raider",
//     "platforms": [
//         6,
//         7,
//         13,
//         14,
//         32,
//         34,
//         39,
//         42,
//         45
//     ],
//     "player_perspectives": [
//         2
//     ],
//     "popularity": 4.566234205629367,
//     "pulse_count": 9,
//     "rating": 83.9422770015487,
//     "rating_count": 177,
//     "release_dates": [
//         1977,
//         1978,
//         1980,
//         2292,
//         2293,
//         2294,
//         61305,
//         61306,
//         61308,
//         151004
//     ],
//     "screenshots": [
//         16876,
//         37978,
//         37979,
//         37980,
//         37981
//     ],
//     "similar_games": [
//         20,
//         533,
//         538,
//         1020,
//         1164,
//         1377,
//         2031,
//         3188,
//         9498,
//         9727
//     ],
//     "slug": "tomb-raider",
//     "summary": "Adventurer Lara Croft has been hired to recover the pieces of an ancient artifact known as the Scion. With her fearless acrobatic style she runs, jumps, swims and climbs her way towards the truth of its origin and powers - leaving only a trail of empty tombs and gun-cartridges in her wake.",
//     "tags": [
//         1,
//         21,
//         33,
//         268435461,
//         268435464,
//         268435465,
//         268435487,
//         536870933,
//         536870958,
//         536870976,
//         536870984,
//         536870999,
//         536871033,
//         536871041,
//         536871044,
//         536871133,
//         536871251,
//         536871277,
//         536871302,
//         536871306,
//         536871332,
//         536871470,
//         536871506,
//         536871510,
//         536871535,
//         536871570,
//         536871610,
//         536871682,
//         536871776,
//         536871784,
//         536871814,
//         536871838,
//         536871874,
//         536871878,
//         536871931,
//         536871937,
//         536871945,
//         536872010,
//         536872050,
//         536872070,
//         536872102,
//         536872114,
//         536872140,
//         536872152,
//         536872184,
//         536872201,
//         536872205,
//         536872232,
//         536872257,
//         536872333,
//         536872366,
//         536872406,
//         536872419,
//         536872622,
//         536872626,
//         536872628,
//         536872649,
//         536872668,
//         536872746,
//         536872758,
//         536872883,
//         536872961,
//         536873024,
//         536873053,
//         536873066,
//         536873192,
//         536873236,
//         536873249,
//         536873326,
//         536873327,
//         536873350,
//         536873362,
//         536873364,
//         536873425,
//         536873455,
//         536873473,
//         536873590,
//         536873591,
//         536873753,
//         536873787,
//         536873973,
//         536874115,
//         536874140,
//         536874209,
//         536874398,
//         536874552,
//         536874706,
//         536874743,
//         536874813,
//         536874822,
//         536874906,
//         536874916,
//         536874947,
//         536875042,
//         536875046,
//         536875047,
//         536875050,
//         536875052,
//         536875057,
//         536875073,
//         536875078,
//         536875083,
//         536875085,
//         536875089,
//         536875095,
//         536875097,
//         536875099,
//         536875107,
//         536875114,
//         536875127,
//         536875130,
//         536875157,
//         536875158,
//         536875192,
//         536875194,
//         536875196,
//         536875199,
//         536875204,
//         536875205,
//         536875208,
//         536875216,
//         536875228,
//         536875229,
//         536875232,
//         536875242,
//         536875249,
//         536875250,
//         536875257,
//         536875265,
//         536875271,
//         536875275,
//         536875276,
//         536875281,
//         536875284,
//         536875286,
//         536875301,
//         536875302,
//         536875304,
//         536875305,
//         536875306,
//         536875308,
//         536875309,
//         536875312,
//         536875315,
//         536875319,
//         536875324,
//         536875331,
//         536875340,
//         536875342,
//         536875344,
//         536875358,
//         536875362,
//         536875372,
//         536875396,
//         536875400,
//         536875420,
//         536875421,
//         536875426,
//         536875432,
//         536875437,
//         536875438,
//         536875453,
//         536875454,
//         536875455,
//         536875456,
//         536875460,
//         536875464,
//         536875483,
//         536875485,
//         536875486,
//         536875488,
//         536875490,
//         536875491,
//         536875492,
//         536875493,
//         536875494,
//         536875502,
//         536875504,
//         536875506,
//         536875507,
//         536875508,
//         536875523,
//         536875525,
//         536875526,
//         536875527,
//         536875528,
//         536875531,
//         536875532,
//         536875536,
//         536875537,
//         536875540,
//         536875542,
//         536875544,
//         536875545,
//         536875546,
//         536875547,
//         536875549,
//         536875550,
//         536875554,
//         536875571,
//         536875572,
//         536875574,
//         536875580,
//         536875583,
//         536875593,
//         536875597,
//         536875606,
//         536875609,
//         536875621,
//         536875623,
//         536875624,
//         536875625,
//         536875638,
//         536875639,
//         536875643,
//         536875650,
//         536875657,
//         536875667,
//         536875668,
//         536875674,
//         536875675,
//         536875691,
//         536875693,
//         536875695,
//         536875699,
//         536875700,
//         536875705,
//         536875729,
//         536875741,
//         536875742,
//         536875743,
//         536875745,
//         536875757,
//         536875760,
//         536875777,
//         536875781,
//         536875792,
//         536875797,
//         536875803,
//         536875804,
//         536875808,
//         536875809,
//         536875811,
//         536875813,
//         536875819,
//         536875822,
//         536875830,
//         536875832,
//         536875840,
//         536875870,
//         536875889,
//         536875891,
//         536875903,
//         536875910,
//         536875911,
//         536875912,
//         536875919,
//         536875920,
//         536875937,
//         536875941,
//         536875951,
//         536876008,
//         536876011,
//         536876014,
//         536876015,
//         536876021,
//         536876023,
//         536876029,
//         536876031,
//         536876076,
//         536876083,
//         536876084,
//         536876088,
//         536876097,
//         536876108,
//         536876129,
//         536876168,
//         536876169,
//         536876171,
//         536876172,
//         536876178,
//         536876181,
//         536876183,
//         536876185,
//         536876186,
//         536876205,
//         536876207,
//         536876210,
//         536876220,
//         536876221,
//         536876235,
//         536876241,
//         536876257,
//         536876261,
//         536876262,
//         536876271,
//         536876274,
//         536876275,
//         536876277,
//         536876287,
//         536876298,
//         536876303,
//         536876318,
//         536876319,
//         536876321,
//         536876322,
//         536876325,
//         536876331,
//         536876333,
//         536876339,
//         536876351,
//         536876356,
//         536876358,
//         536876364,
//         536876365,
//         536876374,
//         536876377,
//         536876379,
//         536876413,
//         536876414,
//         536876416,
//         536876419,
//         536876423,
//         536876427,
//         536876430,
//         536876446,
//         536876447,
//         536876461,
//         536876464,
//         536876466,
//         536876473,
//         536876476,
//         536876493,
//         536876498,
//         536876502,
//         536876504,
//         536876511,
//         536876521,
//         536876528,
//         536876533,
//         536876534,
//         536876540,
//         536876553,
//         536876556,
//         536876557,
//         536876562,
//         536876564,
//         536876570,
//         536876577,
//         536876592,
//         536876599,
//         536876617,
//         536876624,
//         536876625,
//         536876629,
//         536876642,
//         536876654,
//         536876665,
//         536876668,
//         536876669,
//         536876674,
//         536876683,
//         536876687,
//         536876695,
//         536876701,
//         536876711,
//         536876722,
//         536876735,
//         536876751,
//         536876755,
//         536876757,
//         536876767,
//         536876770,
//         536876797,
//         536876816,
//         536876817,
//         536876826,
//         536876832,
//         536876847,
//         536876851,
//         536876852,
//         536876853,
//         536876862,
//         536876868,
//         536876877,
//         536876879,
//         536876880,
//         536876898,
//         536876901,
//         536876911,
//         536876919,
//         536876929,
//         536876938,
//         536876964,
//         536876974,
//         536877031,
//         536877040,
//         536877043,
//         536877047,
//         536877056,
//         536877077,
//         536877127,
//         536877128,
//         536877151,
//         536877157,
//         536877160,
//         536877169,
//         536877170,
//         536877173,
//         536877207,
//         536877210,
//         536877237,
//         536877253,
//         536877286,
//         536877287,
//         536877288,
//         536877289,
//         536877290,
//         536877294,
//         536877309,
//         536877322,
//         536877338,
//         536877352,
//         536877354,
//         536877355,
//         536877369,
//         536877384,
//         536877389,
//         536877393,
//         536877405,
//         536877424,
//         536877425,
//         536877501,
//         536877536,
//         536877537,
//         536877567,
//         536877628,
//         536877648,
//         536877649,
//         536877650,
//         536877661,
//         536877664,
//         536877725,
//         536877753,
//         536877762,
//         536877775,
//         536877780,
//         536877807,
//         536877809,
//         536877815,
//         536877828,
//         536877906,
//         536877907,
//         536877912,
//         536877950,
//         536877955,
//         536877956,
//         536877958,
//         536877964,
//         536877965,
//         536877976,
//         536877985,
//         536877986,
//         536877992,
//         536878004,
//         536878037,
//         536878064,
//         536878065,
//         536878127,
//         536878132,
//         536878147,
//         536878200,
//         536878215,
//         536878217,
//         536878246,
//         536878315,
//         536878317,
//         536878320,
//         536878377,
//         536878406,
//         536878409,
//         536878410,
//         536878415,
//         536878427,
//         536878464,
//         536878481,
//         536878488,
//         536878490,
//         536878555,
//         536878567,
//         536878572,
//         536878576,
//         536878584,
//         536878591,
//         536879012,
//         536879042,
//         536879050,
//         536879072,
//         536879089,
//         536879177,
//         536879211,
//         536879714,
//         536879718,
//         536879731,
//         536879759,
//         536879766,
//         536879818,
//         536879870,
//         536880042,
//         536880170,
//         536880195,
//         536880208,
//         536880276,
//         536880292,
//         536880374,
//         536880441,
//         536880567,
//         536880761,
//         536880863,
//         536880883,
//         536880884,
//         536880948,
//         536880997,
//         536881045,
//         536881061,
//         536881330,
//         536881398,
//         536881456,
//         536881642,
//         536881663,
//         536881726,
//         536882011,
//         536882199,
//         536882223,
//         536882263,
//         536882765,
//         536883082,
//         536883092,
//         536883172,
//         536883622,
//         536883655,
//         536883760,
//         536884038,
//         536884039,
//         536884863
//     ],
//     "themes": [
//         1,
//         21,
//         33
//     ],
//     "time_to_beat": 912,
//     "total_rating": 84.27113850077436,
//     "total_rating_count": 179,
//     "updated_at": "2019-11-21T00:00:00.000000Z",
//     "url": "https://www.igdb.com/games/tomb-raider",
//     "websites": [
//         15831,
//         77364,
//         99593
//     ]
// }